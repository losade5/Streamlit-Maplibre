<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>streamlit-component-x</title>
  <script src="./streamlit-component-lib.js"></script>
  <script src="./main.js"></script>
  <link rel="stylesheet" href="./style.css" />

  <script src="https://unpkg.com/maplibre-gl@^5.6.0/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@^5.6.0/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    #map {
      width: 700px;
      height: 800px;

      box-sizing: border-box;
    }

    #debug-overlay {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      font-size: 20px;
      padding: 18px 28px;
      z-index: 1000;
      max-width: 90vw;
      word-break: break-all;
      pointer-events: none;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="debug-overlay" style="display: none;"></div>
  <script>
    // Debug overlay visibility flag
    const SHOW_DEBUG_OVERLAY = false; // Set to true to show debug overlay

    const stateNames = [
      "West Virginia",
      "Florida",
      "Illinois",
      "Minnesota",
      "Maryland",
      "Rhode Island",
      "Idaho",
      "New Hampshire",
      "North Carolina",
      "Vermont",
      "Connecticut",
      "Delaware",
      "New Mexico",
      "California",
      "New Jersey",
      "Wisconsin",
      "Oregon",
      "Nebraska",
      "Pennsylvania",
      "Washington",
      "Louisiana",
      "Georgia",
      "Alabama",
      "Utah",
      "Ohio",
      "Texas",
      "Colorado",
      "South Carolina",
      "Oklahoma",
      "Tennessee",
      "Wyoming",
      "Hawaii",
      "North Dakota",
      "Kentucky",
      "United States Virgin Islands",
      "Commonwealth of the Northern Mariana Islands",
      "Guam",
      "Maine",
      "New York",
      "Nevada",
      "Alaska",
      "American Samoa",
      "Michigan",
      "Arkansas",
      "Mississippi",
      "Missouri",
      "Montana",
      "Kansas",
      "Indiana",
      "Puerto Rico",
      "South Dakota",
      "Massachusetts",
      "Virginia",
      "District of Columbia",
      "Iowa",
      "Arizona",
    ];

    // Color levels for job numbers (light to dark green)
    const jobNumberColors = [
      "#b9f6ca", // tiny
      "#69f0ae", // small
      "#00e676", // medium
      "#00c853", // big
      "#006400", // bigger
    ];

    // Assign color based on job number
    function getColorForJobNumber(jobNumber) {
      if (jobNumber <= 100) return jobNumberColors[0];
      if (jobNumber <= 200) return jobNumberColors[1];
      if (jobNumber <= 300) return jobNumberColors[2];
      if (jobNumber <= 400) return jobNumberColors[3];
      return jobNumberColors[4];
    }

    // Generate the state object
    const statesData = {};
    stateNames.forEach((name) => {
      const jobNumber = Math.floor(Math.random() * 501); // 0 to 500
      statesData[name] = {
        Label: name,
        borderColor: "#000000",
        fillColor: getColorForJobNumber(jobNumber),
        jobNumber: jobNumber,
      };
    });

    // Example: log a few states
    console.log(statesData["California"]);
    console.log(statesData["Texas"]);

    const blankStyle = {
      version: 8,
      sources: {},
      layers: [],
    };

    // --- Map creation logic ---
    let map = null;
    let currentStyleType = null; // 'blank' or 'tile'

    function buildMap(styleType, center, zoom, fillOpacity, showMetroCircles) {
      // Remove old map if exists
      if (map) {
        map.remove();
        document.getElementById('map').innerHTML = '';
      }
      const style = styleType === 'blank' ? blankStyle : "https://tiles.openfreemap.org/styles/positron";
      map = new maplibregl.Map({
        container: "map",
        style: style,
        center: center,
        zoom: zoom,
      });
      map.on("load", function () {
        // Add states
        fetch("statesGeo.json")
          .then((response) => response.json())
          .then((data) => {
            data.features.forEach((feature) => {
              const stateName = feature.properties.NAME;
              const stateData = statesData[stateName];
              if (stateData) {
                feature.properties.fillColor = stateData.fillColor;
                feature.properties.borderColor = stateData.borderColor;
                feature.properties.jobNumber = stateData.jobNumber;
              }
            });
            map.addSource("states", {
              type: "geojson",
              data: data,
            });
            map.addLayer({
              id: "states-fill",
              type: "fill",
              source: "states",
              paint: {
                "fill-color": ["get", "fillColor"],
                "fill-opacity": fillOpacity,
              },
            });
            map.addLayer({
              id: "states-outline",
              type: "line",
              source: "states",
              paint: {
                "line-color": ["get", "borderColor"],
                "line-width": 1,
                "line-opacity": 1,
              },
            });
          });

        // Helper to scale job count to radius (10-50px)
        function getCircleRadius(jobs) {
          const minJobs = 0, maxJobs = 500, minR = 10, maxR = 50;
          return minR + ((jobs - minJobs) / (maxJobs - minJobs)) * (maxR - minR);
        }


        const metroGeoJson = {
          type: "FeatureCollection",
          features: metroCircles.map((m) => ({
            type: "Feature",
            properties: {
              name: m.name,
              jobs: m.jobs,
              radius: getCircleRadius(m.jobs),
            },
            geometry: {
              type: "Point",
              coordinates: m.coords,
            },
          })),
        };



        // Add metro circles
        map.addSource("metro-circles", {
          type: "geojson",
          data: metroGeoJson,
        });
        map.addLayer({
          id: "metro-circles-layer",
          type: "circle",
          source: "metro-circles",
          paint: {
            "circle-radius": ["get", "radius"],
            "circle-color": "#1976d2",
            "circle-opacity": 0.6,
            "circle-stroke-width": 2,
            "circle-stroke-color": "#0d47a1",
          },
          layout: {
            "visibility": showMetroCircles ? "visible" : "none",
          },
        });
        // Lock map interactions for all views
        setMapLock(map, true);
      });
    }

    // --- View logic ---
    function applyView(view) {
      let fillOpacity, styleType, showMetroCircles, center, zoom;
      if (view === "country") {
        fillOpacity = 1;
        styleType = 'blank';
        showMetroCircles = false;
        center = [-98, 39];
        zoom = 3;
      } else if (view === "country-metro") {
        fillOpacity = 0;
        styleType = 'tile';
        showMetroCircles = true;
        center = [-98, 39];
        zoom = 3;
      } else {
        const metro = getMetroByName(view);
        if (metro) {
          fillOpacity = 0;
          styleType = 'tile';
          showMetroCircles = true;
          center = metro.coords;
          zoom = 9;
        } else {
          // fallback to country
          fillOpacity = 1;
          styleType = 'blank';
          showMetroCircles = false;
          center = [-98, 39];
          zoom = 3;
        }
      }
      if (currentStyleType !== styleType) {
        currentStyleType = styleType;
        buildMap(styleType, center, zoom, fillOpacity, showMetroCircles);
      } else {
        // Just update layers if style type didn't change
        if (map) {
          map.flyTo({ center: center, zoom: zoom });
          if (map.getLayer("states-fill")) map.setPaintProperty("states-fill", "fill-opacity", fillOpacity);
          if (map.getLayer("metro-circles-layer")) map.setLayoutProperty("metro-circles-layer", "visibility", showMetroCircles ? "visible" : "none");
        }
      }
    }

    function setMapLock(map, locked) {
      if (locked) {
        map.dragPan.disable();
        map.scrollZoom.disable();
        map.boxZoom.disable();
        map.keyboard.disable();
        map.doubleClickZoom.disable();
        map.touchZoomRotate.disable();
      } else {
        map.dragPan.enable();
        map.scrollZoom.enable();
        map.boxZoom.enable();
        map.keyboard.enable();
        map.doubleClickZoom.enable();
        map.touchZoomRotate.enable();
      }
    }

    // Static metro area data for circles
    const metroCircles = [
      { name: "New York Metro", coords: [-74.006, 40.7128], jobs: 480 },
      { name: "Los Angeles Metro", coords: [-118.2437, 34.0522], jobs: 350 },
      { name: "Chicago Metro", coords: [-87.6298, 41.8781], jobs: 410 },
      { name: "Dallas Metro", coords: [-96.797, 32.7767], jobs: 220 },
      { name: "Houston Metro", coords: [-95.3698, 29.7604], jobs: 300 },
      { name: "Miami Metro", coords: [-80.1918, 25.7617], jobs: 120 },
      { name: "Atlanta Metro", coords: [-84.388, 33.749], jobs: 60 },
      { name: "San Francisco Metro", coords: [-122.4194, 37.7749], jobs: 500 },
      { name: "Seattle Metro", coords: [-122.3321, 47.6062], jobs: 270 },
      { name: "Denver Metro", coords: [-104.9903, 39.7392], jobs: 10 },
    ];

    function getMetroByName(name) {
      return metroCircles.find((m) => m.name === name);
    }

    // --- Streamlit event handler ---
    function onRender(event) {
      const { data } = event.detail.args || {};
      // Debug overlay update
      let debugText = '';
      if (data) {
        try {
          const parsed = JSON.parse(data);
          debugText = `<b>view:</b> ${parsed.view || ''}<br><b>JSON:</b> ${data}`;
          if (parsed.view) {
            applyView(parsed.view);
          }
        } catch (e) {
          debugText = `<b>Invalid JSON:</b> ${data}`;
        }
      } else {
        debugText = '<b>No data received from Streamlit</b>';
      }
      const debugOverlay = document.getElementById('debug-overlay');
      debugOverlay.innerHTML = debugText;
      debugOverlay.style.display = SHOW_DEBUG_OVERLAY ? 'block' : 'none';
    }

    // Attach our `onRender` handler to Streamlit's render event.
    /*  if (window.Streamlit) { */
    Streamlit.events.addEventListener(Streamlit.RENDER_EVENT, onRender);
    Streamlit.setComponentReady();
    Streamlit.setFrameHeight();

    /*    } else {
         console.log("Streamlit not found, using fallback event listener.");
         // fallback for dev/test outside Streamlit
         window.addEventListener("streamlit:render", onRender);
       } */
  </script>
</body>

</html>